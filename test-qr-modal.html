<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Modal Flow</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .step h3 { margin-top: 0; color: #1B5E20; }
        button { background: #1B5E20; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0d3d13; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üß™ Test QR Payment Modal Flow</h1>
    
    <div class="step">
        <h3>B∆∞·ªõc 1: ƒêƒÉng nh·∫≠p</h3>
        <p>Email: <input type="text" id="email" value="qrtest@example.com"></p>
        <p>Password: <input type="password" id="password" value="Test123!@#"></p>
        <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
        <div id="login-result"></div>
    </div>

    <div class="step">
        <h3>B∆∞·ªõc 2: Th√™m s√°ch v√†o gi·ªè</h3>
        <p>Book ID: <input type="number" id="bookId" value="30"></p>
        <button onclick="addToCart()">Th√™m v√†o gi·ªè</button>
        <div id="cart-result"></div>
    </div>

    <div class="step">
        <h3>B∆∞·ªõc 3: Checkout</h3>
        <p>ƒê·ªãa ch·ªâ: <input type="text" id="address" value="123 Test Street, Hanoi"></p>
        <button onclick="checkout()">Thanh to√°n</button>
        <div id="checkout-result"></div>
    </div>

    <div class="step">
        <h3>B∆∞·ªõc 4: Xem QR Code</h3>
        <div id="qr-display"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let token = localStorage.getItem('test_token') || '';

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                
                if (data.success) {
                    token = data.data.token;
                    localStorage.setItem('test_token', token);
                    document.getElementById('login-result').innerHTML = 
                        `<p class="success">‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! User: ${data.data.user.email}</p>`;
                } else {
                    document.getElementById('login-result').innerHTML = 
                        `<p class="error">‚ùå L·ªói: ${data.error?.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                document.getElementById('login-result').innerHTML = 
                    `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
            }
        }

        async function addToCart() {
            const bookId = parseInt(document.getElementById('bookId').value);
            
            try {
                const response = await fetch(`${API_BASE}/cart/items`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ book_id: bookId, quantity: 1 })
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('cart-result').innerHTML = 
                        `<p class="success">‚úÖ ƒê√£ th√™m v√†o gi·ªè! T·ªïng: ${data.data.total_items} s·∫£n ph·∫©m, ${data.data.total_amount.toLocaleString('vi-VN')}ƒë</p>`;
                } else {
                    document.getElementById('cart-result').innerHTML = 
                        `<p class="error">‚ùå L·ªói: ${data.error?.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                document.getElementById('cart-result').innerHTML = 
                    `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
            }
        }

        async function checkout() {
            const address = document.getElementById('address').value;
            
            try {
                const response = await fetch(`${API_BASE}/orders/checkout`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        shipping_address: address,
                        payment_method: 'bank_transfer'
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    document.getElementById('checkout-result').innerHTML = `
                        <p class="success">‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!</p>
                        <pre>${JSON.stringify({
                            order_id: result.order_id,
                            order_number: result.order_number,
                            total_amount: result.total_amount,
                            payment_status: result.payment_status,
                            transfer_content: result.payment?.transfer_content,
                            bank_name: result.payment?.bank_info?.bank_name,
                            expires_in_seconds: result.payment?.expires_in_seconds
                        }, null, 2)}</pre>
                    `;
                    
                    // Display QR
                    if (result.payment?.qr_data_url) {
                        document.getElementById('qr-display').innerHTML = `
                            <h4>M√£ QR thanh to√°n:</h4>
                            <img src="${result.payment.qr_data_url}" alt="QR Code" style="max-width: 300px; border: 1px solid #ddd; border-radius: 8px;">
                            <p><strong>N·ªôi dung CK:</strong> ${result.payment.transfer_content}</p>
                            <p><strong>Ng√¢n h√†ng:</strong> ${result.payment.bank_info.bank_name}</p>
                            <p><strong>STK:</strong> ${result.payment.bank_info.account_no}</p>
                            <p><strong>Ch·ªß TK:</strong> ${result.payment.bank_info.account_name}</p>
                            <p><strong>S·ªë ti·ªÅn:</strong> ${result.total_amount.toLocaleString('vi-VN')}ƒë</p>
                        `;
                    } else {
                        document.getElementById('qr-display').innerHTML = 
                            `<p class="error">‚ùå Kh√¥ng c√≥ QR data trong response!</p>`;
                    }
                } else {
                    document.getElementById('checkout-result').innerHTML = 
                        `<p class="error">‚ùå L·ªói: ${data.error?.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                document.getElementById('checkout-result').innerHTML = 
                    `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
            }
        }

        // Check if already logged in
        if (token) {
            document.getElementById('login-result').innerHTML = 
                '<p class="success">‚úÖ ƒê√£ c√≥ token t·ª´ session tr∆∞·ªõc</p>';
        }
    </script>
</body>
</html>
